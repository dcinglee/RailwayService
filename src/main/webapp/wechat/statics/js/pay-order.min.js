function add(e,t){var r,i,a;try{r=e.toString().split(".")[1].length}catch(e){r=0}try{i=t.toString().split(".")[1].length}catch(e){i=0}return a=Math.pow(10,Math.max(r,i)),(mul(e,a)+mul(t,a))/a}function sub(e,t){var r,i,a;try{r=e.toString().split(".")[1].length}catch(e){r=0}try{i=t.toString().split(".")[1].length}catch(e){i=0}return a=Math.pow(10,Math.max(r,i)),(mul(e,a)-mul(t,a))/a}function mul(e,t){var r=0,i=e.toString(),a=t.toString();try{r+=i.split(".")[1].length}catch(e){}try{r+=a.split(".")[1].length}catch(e){}return Number(i.replace(".",""))*Number(a.replace(".",""))/Math.pow(10,r)}function div(e,t){var r,i,a=0,n=0;try{a=e.toString().split(".")[1].length}catch(e){}try{n=t.toString().split(".")[1].length}catch(e){}return r=Number(e.toString().replace(".","")),i=Number(t.toString().replace(".","")),mul(r/i,Math.pow(10,n-a))}function getTime(e,t,r,i){return Number(e)===t&&(i+=t,i>60&&(i%=60,i<10&&(i="0"+String(i)),r+=1),e=[r,i].join(":")),e}function compareTime(e,t){var r=e.split(":").map(function(e){return+e}),t=t?t:30,i=JSON.parse(sessionStorage.route).aboardTime.split(":").map(function(e){return+e});return!(60*r[0]+r[1]+t>=60*i[0]+i[1])}$(document).on("click",'input[type="radio"]',function(){var e=$(this).data("name"),t=$(this).parents("div.radio").find('input[type="radio"][data-name='+e+"]"),r=$(this).data("target"),i=$('[data-name="cost"]'),a=Number(i[0].innerText.split("￥")[1]),n=$(document).find("div[data-name=fare]"),s=Number(n.find(".money").text().split("￥")[1]),o=$(this).data("picker"),c=$(this).data("reset"),d=this;if(o&&!order&&0===$(".weui-picker-modal").length&&$(o).picker("open"),c&&$(c).text("稍晚时间"),$(this).attr("checked"))return!1;$.each(t,function(){d==this?$(this).attr("checked",!0):$(this).attr("checked",!1)}),r&&("receipt"==r?($("#time").hide(),$("#receipt-place,#receipt-time").show(),""!=$("#time-select").val()&&$("#last-time").val($("#time-select").val()),n.show(),i.text("￥"+add(a,s))):($("#receipt-place,#receipt-time").hide(),n.hide(),i.text("￥"+sub(a,s)),$("#last-time,#time-select").val(),""!==$("#last-time").val()&&$("#time-select").val($("#last-time").val()),$("#time").show()))});var errmsg,order=sessionStorage.Order?JSON.parse(sessionStorage.Order):void 0;$.ajax({url:"/RailwayService/order/affirmOrder?merchantId="+sessionStorage.merchantId+"&stationId="+sessionStorage.stationId,type:"GET",dataType:"json",success:function(e){if(e.success){var t,r=e.data.user,i=0,a=/[^\u4e00-\u9fa5]/,n=r.name?r.name:r.nickName;order?($("#username").val(order.customerName),$("#phone").val(order.customerPhoneNo)):(n&&$("#username").val(a.test(n)?"":n),r.phoneNo&&$("#phone").val(r.phoneNo)),initLocationPicker(e.data.listDeliverAddress),initTimePicker(),$(".order-merchant span").text(e.data.merchant.address?e.data.merchant.address:"商家暂未设置地址resb.data.merchant.address");var s={};$.each(e.data.listShoppingCart,function(){t=mul(this.price,this.count),i=add(i,t),s[this.productId]={num:this.count},$("div.order-accounts-bd").append($("#clone").clone().html().replace("__商品名称__",this.productName).replace("__商品数量__",this.count).replace("__商品价格__",t)),productList.push({productId:this.productId,quantity:this.count})}),sessionStorage.setItem("shoppingCart",JSON.stringify(s)),$("div.order-accounts-bd").append($("#clone").clone().html().replace("__商品名称__","配送费").replace("X__商品数量__","").replace("__商品价格__",e.data.distributionCosts).replace("tr","fare")),i=add(i,e.data.distributionCosts),$("[data-name=cost]").text("￥"+i),order&&(order.address&&$("#location-select").val(order.address),$(order.typeId).click(),$(order.timeId).click().parents("label").find(".font-orange").text(order.afterTime?order.afterTime:order.latestServiceTime),sessionStorage.removeItem("Order"),order=null),JSON.parse(sessionStorage.delivery)||($("#delivery").attr("disabled",!0).parent().hide(),$("#self_take").click()),$.each(e.data.stationForImageRelaList,function(){$(".pay-mask .map").append('<img src="'+String(this)+'" alt="图片加载失败" style="color: #fff;">')})}else errmsg=e.message},error:function(e){errmsg=e.statusText},complete:function(){errmsg&&($.toast(errmsg,"forbidden"),setTimeout(function(){history.back(-1)},2500))}});var initLocationPicker=function(e){$("#location-select").picker({payOrder:!0,title:"请选择您的收货地址",cols:[{textAlign:"center",values:$.map(e,function(e){return e.address})}],address:e,onClose:function(e){$(e.params.input).attr("data-deliverAddressId",e.params.address[e.params.cols[0].activeIndex].deliverAddressId)}})},initTimePicker=function(){for(var e=new Date,t=e.getMinutes()+20,r=e.getHours(),i=[],a=[],n=[],s=0,o=0,c="",d=0;d<=55;d+=5)n.push(d>5?String(d):"0"+String(d));if(t>60&&(r+=1,t-=60),s=t%5,(t+=0!==s?5-s:5)>55)r++,a=n;else for(;t<=55;)a.push(t>5?String(t):"0"+String(t)),t+=5;for(;r<24;++r)i.push(r);if(sessionStorage.route){var l=JSON.parse(sessionStorage.route).aboardTime.split(":"),u=parseInt(l[0]),m=parseInt(l[1]);m-=15,60*u+m>60*r+t&&(m<0&&(u-=1,m+=60),m<10&&(m="0"+String(m)),c=String(u)+":"+String(m))}$("#last-time,#time-select").val(c).picker({title:"请选择您的取货时间",time:!0,onClose:function(e){$($(e.params.input).data("target")).text(e.value.join(":"))},cols:[{textAlign:"center",values:i,cssClass:"time-picker",onChange:function(e,t){var r,i=e.cols[0].activeIndex,s=e.cols[1].value;(0!==i&&0===o||0===i&&0!==o)&&(r=0===i?a:n,e.cols[1].replaceValues(r,r),$("#time-select").picker("setValue",[t,s])),o=i}},{textAlign:"center",cssClass:"time-picker",values:a}]})},productList=[];$("a#submit").click(function(){var e,t,r,i,a,n,s=$(":checked").attr("id"),o=$("#username").val().trim(),c=$("#phone").val().trim(),d=$("#location-select").data("deliveraddressid"),l=new Date,u=l.getHours(),m=l.getMinutes(),p={merchantId:sessionStorage.merchantId},h=/[^\u4e00-\u9fa5]/;if(0===o.length)return $.toast("请输入联系人姓名","forbidden");if(h.test(o))return $.toast("姓名只能为中文","forbidden");if(p.customerName=o,0===c.length)return $.toast("请输入联系人手机号码","forbidden");if(p.customerPhoneNo=c,i="#"+s,"delivery"===s){if(s=16002,!d)return $.toast("请选择收货位置","forbidden");p.deliverAddress=d,a="#"+$("#receipt-time").find(":checked").attr("id"),e=$("#receipt-time").find(":checked").parents("label").find("span.font-orange").text(),30===e&&(r=30),p.latestServiceTime=getTime(e,30,u,m),t="送餐时间为:"+p.latestServiceTime}else s=16001,a="#"+$("#time").find(":checked").attr("id"),e=$("#time").find(":checked").parents("label").find("span.font-orange").text(),10===e&&(r=10),p.latestServiceTime=getTime(e,10,u,m),t="取货时间为:"+p.latestServiceTime;return p.deliverType=s,p.listProduct=productList,n=p.slice(0),n.timeId=a,n.typeId=i,n.afterTime=r,sessionStorage.route?compareTime(p.latestServiceTime,r)?void $.confirm(t,"<span style='font-weight:bold;'>确认支付?</span>",function(){$.ajax({url:"/RailwayService/order/createOrder",type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify(p),beforeSend:function(){$.showLoading()},success:function(e){if($.hideLoading(),e.success){var t=e.data;setTimeout(function(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:t.appId,timeStamp:t.timeStamp,nonceStr:t.nonceStr,package:t.packAge,signType:t.signType,paySign:t.paySign},function(e){"get_brand_wcpay_request:ok"===e.err_msg?($.toast("支付成功","success"),setTimeout(function(){sessionStorage.setItem("orderId",t.orderId),window.location.href="/RailwayService/wechat/orderDetail.html"},2500)):$.toast("支付失败","cancel")})},300)}else $.toast(e.message,"forbidden")},error:function(e){$.hideLoading(),$.toast(e.statusText,"forbidden")}})}):$.confirm("发车时间不足"+(16001===s?10:30)+"分钟,不允许下单,或者修改行程","警告",function(){sessionStorage.Order=JSON.stringify(n),window.location.href="route.html"}):(sessionStorage.Order=JSON.stringify(n),$.alert("您尚未设置行程，点击确认后开始行程设置","提示",function(){return window.location.href="route.html"}))});var oHeight=$(document).height();$(window).resize(function(){$(document).height()!==oHeight?$(".footer-wrap").css("display","none"):$(".footer-wrap").css("display","block")}),$("#location-select,#last-time,#time-select").click(function(){document.activeElement.blur()}),$("#location-select,#last-time,#time-select").click(function(){$(".pay-mask").fadeIn("fast")}),$(document).on("click","a.close-picker",function(){$(".pay-mask").fadeOut("fast")});
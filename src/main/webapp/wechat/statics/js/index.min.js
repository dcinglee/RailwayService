var isTrip=true,length,loadNodes,imgLeft,imgRight,logoLeft,logoRight,n=0;var trip=JSON.parse(sessionStorage.getItem("route"));(function(){if(sessionStorage.localStation){$(".stationName .localStation").html(sessionStorage.getItem("localStation"));var obj={};obj.stationId=sessionStorage.getItem("localStationId");getHot("../product/queryProductByRecommend",obj);getSelect(obj);var nodes=$(".classifyLink");for(var i=0;i<nodes.length;i++){nodes.eq(i).attr("data-stationId",obj.stationId)}}else{getLocation()}getTrip();getBanner();$(".main").scroll(lazyload);function lazyload(event){for(var i=n;i<length;i++){if(loadNodes.eq(i).offset().top<parseInt($(".main").height())+parseInt($(".main").scrollTop())){var src=imgLeft.eq(i).attr("data-src");var src1=imgRight.eq(i).attr("data-src");var src2=logoLeft.eq(i).attr("data-src");var src3=logoRight.eq(i).attr("data-src");imgLeft.eq(i).attr("src",src);imgRight.eq(i).attr("src",src1);logoLeft.eq(i).attr("src",src2);logoRight.eq(i).attr("src",src3);n=i+1}}}})();$(document).on("click",".stationName ",function(){$(".stationList").toggle()}).on("click",".stationList li",function(){$(".stationName .localStation").html($(this).find("span").html());sessionStorage.setItem("localStation",$(this).find("span").html());sessionStorage.setItem("localStationId",$(this).attr("stationId"));var obj={};obj.stationId=$(this).attr("stationId");getHot("../product/queryProductByRecommend",obj);getSelect(obj);var nodes=$(".classifyLink");for(var i=0;i<nodes.length;i++){nodes.eq(i).attr("data-stationId",$(this).attr("stationId"))}}).on("click","#mask,.closeMask",function(){hideMask();if(trip){trip.toRoute=false;sessionStorage.setItem("route",JSON.stringify(trip))}}).on("click",".myTrips",function(){console.log(isTrip);if(isTrip==false){window.location.href="route.html"}else{showMask()}}).on("click",".hotLink,.select-box a",function(){sessionStorage.setItem("merchantId",$(this).attr("data-merchant"));sessionStorage.setItem("productId",$(this).attr("data-product"));sessionStorage.setItem("serviceType",$(this).attr("data-service"));sessionStorage.setItem("stationId",$(this).attr("data-station"));window.location.href="merchandise.html"}).on("click",".changeTrip",function(){window.location.href="route.html"}).on("click",".classifyLink",function(){sessionStorage.setItem("stationId",$(this).attr("data-stationId"));sessionStorage.setItem("serviceType",$(this).attr("data-serviceType"));sessionStorage.setItem("classifyName",$(this).parent().find(".classifyList").html());window.location.href="merchant.html"});$(document).click(function(e){var drag=$(".stationList"),dragel=$(".stationName")[0],target=e.target;if(dragel!==target&&!$.contains(dragel,target)){drag.hide()}});function showMask(){$("#mask").css("height",$(document).height());$("#mask").css("width",$(document).width());$("#mask").show();$(".tripOut").show()}function hideMask(){$("#mask").hide();$(".tripOut").hide()}function ajax(url,param,type){return $.ajax({url:url,data:param||{},type:type||"GET"})}function getTrip(){if(trip&&trip.init){if(trip.toRoute!=false){showMask()}$(".startStation").html(trip.startStation);$(".endStation").html(trip.destination);$(".trainNumber").html(trip.trip);if(trip.aboardTime){$(".startTime").html(trip.aboardTime+"开")}else{$(".startTime").html(" ")}if(trip.arriveTime){$(".endTime").html(trip.arriveTime+"到")}else{$(".endTime").html(" ")}var data={station:trip.startStation,lineNo:trip.trip};getLate(data);getWeather({cityId:trip.cityId});$.each(trip.stations,function(){$(".stationList").append("<li stationid="+this.stationId+"><span class='other'>"+this.stationName+"</span></li>")});$(".changeTrip a").html("修改行程")}else{ajax("../travelRoute/get","","POST").done(function(resp){var data=$.parseJSON(resp);console.log(data);if(data.data){var route={startStation:data.data.aboardStation,destination:data.data.arrivedStation,trip:data.data.lineNo,aboardTime:data.data.aboardTime?data.data.aboardTime.substring(0,data.data.aboardTime.length-1):null};if(route.startStation!=undefined){sessionStorage.setItem("route",JSON.stringify(route))}$(".startStation").html(data.data.aboardStation);$(".endStation").html(data.data.arrivedStation);$(".trainNumber").html(data.data.lineNo);if(data.data.aboardTime){$(".startTime").html(data.data.aboardTime+"开")}else{$(".startTime").html(" ")}if(data.data.arrivedTime){$(".endTime").html(data.data.arrivedTime+"到")}else{$(".endTime").html(" ")}var lateData={station:data.data.aboardStation,lineNo:data.data.lineNo};getLate(lateData);getWeather({cityId:data.data.cityId});$.each(data.data.listStationOnTheWay,function(){$(".stationList").append("<li stationid="+this.stationId+"><span class='other'>"+this.stationName+"</span></li>")});$(".changeTrip a").html("修改行程")}else{isTrip=false;$(".tripTop .fl").html("无当前行程");$(".tripTop .fr").html(" ");$(".tripInfo").html("<p style='margin: 0 auto;'>请设置行程！</p>");$(".late").html("");$(".changeTrip a").html("设置行程");getOnline()}}).fail(function(err){})}}function getLocation(obj){ajax("../entrance/getCurrentStation",obj,"POST").done(function(resp){console.log($.parseJSON(resp));var data=$.parseJSON(resp);if(data.data!=null&&data.success==true){getLocationInfo(data)}else{getLocationInfo(data)}})}function getLocationInfo(data){$(".stationName .localStation").html(data.data.stationName);var obj={};obj.stationId=data.data.stationId;getHot("../product/queryProductByRecommend",obj);getSelect(obj);var nodes=$(".classifyLink");for(var i=0;i<nodes.length;i++){nodes.eq(i).attr("data-stationId",obj.stationId)}}function getWeather(obj){ajax("../entrance/getWeather.do",obj,"POST").done(function(resp){var data=$.parseJSON(resp);if(data.success==true){var str=data.data.weather+data.data.lowTemp+"-"+data.data.upTemp;$(".weather").html(str)}else{$(".weather").html("查询异常！")}})}function getLate(obj){ajax("../entrance/checkTrain.do",obj,"POST").done(function(resp){var data=$.parseJSON(resp);if(data.success==true){$(".late").html(data.data)}else{$(".late").html("暂无到达时间信息")}})}function getOnline(){ajax("../railwayStation/getOnLineStation.do","","POST").done(function(resp){var data=$.parseJSON(resp);if(data.success==true){$.each(data.data,function(){$(".stationList").append("<li stationid="+this.stationId+"><span class='other'>"+this.stationName+"</span></li>")})}else{$.toast(data.message,"forbidden")}}).fail(function(){})}function getBanner(){ajax("../AdBanner/queryAdBanner.action","","POST").done(function(resp){var data=$.parseJSON(resp);if(data.data.length!=0){for(var i=0;i<data.data.length;i++){$(".swiper-wrapper").append("<div class='swiper-slide'><a href="+data.data[i].linkUrl+" style='background:url(.."+data.data[i].imageUrl+") no-repeat;background-size:100% 100%;width:100%;height:100%;display:block'></a></div>")}$(".swiper-slide").eq(0).find("a").css("background-image",data.data[0].imageUrl);setTimeout(function(){for(var j=1;j<data.data.length;j++){$(".swiper-slide").eq(j).find("a").css("background-image",data.data[j].imageUrl)}},5e3);var mySwiper=new Swiper(".swiper-container",{initialSlide:0,loop:true,autoplay:5e3,autoplayDisableOnInteraction:false,pagination:".swiper-pagination",paginationClickable:true,observer:true,observeParents:true})}})}function getSelect(data){ajax("../product/queryHotProductByRecommend",data,"POST").done(function(resp){var data=$.parseJSON(resp);console.log(data);if(data.data!=null&&data.data.length!=0){var goodsLength;if(data.data.length%2==0){goodsLength=data.data.length}else{goodsLength=data.data.length-1}var width=goodsLength/2*32.1-4.6;$(".select .selectBody .selectList").css("width",width+"vw");$(".selectList").empty();for(var i=0;i<goodsLength;i++){var template=$("#selectList").clone().html();var html=template.replace("merchantId",data.data[i].merchantId);html=html.replace("productId",data.data[i].productId);html=html.replace("serviceType",data.data[i].serviceTypeId);html=html.replace("stationId",data.data[i].stationId);if(data.data[i].imageUrl.indexOf("http")>-1){html=html.replace("defaltImg",data.data[i].imageUrl)}else{html=html.replace("defaltImg",".."+data.data[i].imageUrl)}html=html.replace("selectGoodsName1",data.data[i].name);html=html.replace("selectGoodsPrice1","￥"+data.data[i].price);html=html.replace("belongStation1",data.data[i].stationName);$(".selectList").append(html)}$(".selectList .select-box").eq(goodsLength/2-1).css("margin-right","0")}})}function getHot(url,data){ajax(url,data,"POST").done(function(resp){var data=$.parseJSON(resp);console.log(data);$(".hotGoodsLeft").empty();$(".hotGoodsRight").empty();var dataLength;if(data.data.length>=16){dataLength=16}else{dataLength=data.data.length}if(data.data.length!=0){for(var i=0;i<dataLength;i++){var str=$("#hotList").clone().html();var html=str.replace("merchantId",data.data[i].merchantId);html=html.replace("productId",data.data[i].productId);html=html.replace("serviceType",data.data[i].serviceTypeId);html=html.replace("stationId",data.data[i].stationId);if(data.data[i].imageUrl.indexOf("http")>-1){html=html.replace("imgSrc",data.data[i].imageUrl+"?x-oss-process=image/resize,m_lfit,h_150")}else{html=html.replace("imgSrc",".."+data.data[i].imageUrl)}if(data.data[i].logoImageUrl.indexOf("http")>-1){html=html.replace("logoSrc",data.data[i].logoImageUrl)}else{html=html.replace("logoSrc",".."+data.data[i].logoImageUrl)}html=html.replace("goodsName",data.data[i].name);html=html.replace("goodsDescript",data.data[i].introduction);html=html.replace("1000",data.data[i].sales?data.data[i].sales:"0");if(i%2!=0){$(".hotGoodsRight").append(html)}else{$(".hotGoodsLeft").append(html)}}length=$(".hotGoodsLeft .hotLink").length;loadNodes=$(".hotGoodsLeft .hotLink");imgLeft=$(".hotGoodsLeft .goodsImg");imgRight=$(".hotGoodsRight .goodsImg");logoLeft=$(".hotGoodsLeft .logoImg img");logoRight=$(".hotGoodsRight .logoImg img");n=0}})}
function query(t){var a,e,n=$(t),i=n.val().trim().toLowerCase(),o=n.parents("div.content").find('[data-name="content-search"]'),s=o.find(".not-found"),r=o.find(".box-block"),c="",d=!1;""===i?($(this).hasClass("trip")&&o.hide().prev().show(),r.filter(":hidden").show(),d=!0):($(t).hasClass("trip")&&o.show().prev().hide(),r.hide().each(function(){if(c=$(this).text().trim(),"#train"===$(this).data("target"))c=$(this).find(".trip").text().trim().substring(1);else try{if(a=$(this).data("abbr").toLowerCase(),e=$(this).data("spell").toLowerCase(),a.indexOf(i)!==-1||e.indexOf(i)!==-1)return d=!0,$(this).show()}catch(t){console.log(t)}if(c.indexOf(i)!==-1)return d=!0,$(this).show()})),d?s.hide():s.show()}function save_route(t,a){var e;if($.ajax({url:"/RailwayService/travelRoute/add",data:JSON.stringify({customerName:"",customerPhone:"",lineNo:t.trip,carriageNumber:"",seatNumber:"",aboardStation:t.startStation,arrivedStation:t.destination}),type:"POST",async:!1,contentType:"application/json",dataType:"json",success:function(a){a.success?t.stations=a.data.listStationOnTheWay:e=a.message},error:function(t){e=t.statusText}}),e)return $.alert(e,"错误");sessionStorage.setItem("route",JSON.stringify(t)),$.toast("设置成功"),setTimeout(function(){window.location.href=a},2e3)}var obj={},height=$(document).height(),toast=function(t,a){$.toast(t,a?a:"forbidden"),setTimeout(function(){$("a.active").prev().click()},2e3)},get_last_num=function(t){var a=t%4;return a?a:5};$(document).on("click",function(t){t.target!==$("ul")&&t.target!==$(".change-type")[0]&&t.target!==$(".change-type span")[0]&&t.target!==$(".change-type img")[0]&&$("ul").hide()}),$("input").focus(function(){$(window).height()!=height&&$("footer").hide()}),$("input").blur(function(){$("footer").show()}),$("nav a").click(function(){var t=$("nav a.active"),a=$(t.attr("href")),e=a.find("input"),n=$($(this).attr("href"));return this!==t&&"none"!==$(this).prev().find(".nav-value span").css("display")&&(t.removeClass("active"),a.hide(),query(e.val("")),$(this).addClass("active"),n.show(),location.replace(this.href),!1)});var getCurrentStation=function(){var t=!1;renderAllStations(),$("#start i").hide(),$.ajax({url:"/RailwayService/entrance/getCurrentStation",type:"GET",dataType:"json",async:!1,success:function(a){a.success&&(obj.startStation=a.data.stationName,obj.startStationId=a.data.stationId,t=!0)}}),t||(obj.startStation="深圳北",obj.startStationId="IOQ"),$("#start span").text(obj.startStation).show(),$("#train").click(),renderTrain()},renderAllStations=function(t){var a=function(t){$("#start-city .city-content").empty().append('<div class="not-found" style="display: none;">未查询到发车的车次</div>'),$.each(t,function(){$("#start-city .city-content").append('<div class="box-block block" data-target="#start" data-name="'+this.stationName+'" data-abbr="'+this.stationNameAbbr+'" data-spell="'+this.spell+' " data-stationId="'+this.stationId+'"><div><span>'+this.stationName+"</span></div></div>")}),$("#start-city .city-content").find(".box-block:not(:nth-last-of-type(n+"+get_last_num(t.length)+"))").removeClass("block"),e=!0},e=!1;$.ajax({url:"/RailwayService/railwayStation/queryAllSpeedRailWayStations",type:"GET",dataType:"json",async:!1,success:function(t){t.success&&a(t.data)},complete:function(t){e||toast(200===t.status?t.responseJSON.message:t.statusText)}}),t&&$('.box-block[data-name="'+t+'"]').click()},renderTrain=function(t){var a=function(t){var a,n,i={G:[$('.trip-content[data-name="content"] .gaotie'),$('.trip-content[data-name="content-search"] .gaotie')],D:[$('.trip-content[data-name="content"] .dongche'),$('.trip-content[data-name="content-search"] .dongche')]};$.each(i,function(e,i){$.each(i,function(i){this.empty().append('<div class="not-found" style="display: none;">未查询到发车的车次</div>'),n=this,$.each(t[e],function(t){a='<div class="box-block block" data-target="#train" data-trip="G1"><span class="trip">G1</span><div class="time">1:11</div></div>'.replace(/G1/g,this.lineNo).replace("1:11",this.departTime),0===i?(t<19&&n.append(a),19===t&&n.append('<div class="box-block more block" data-toggle=".checi">查看更多</div>'.replace("checi","G"===e?"gaotie":"dongche"))):n.append(a)}),0===n.find(".box-block").length&&n.find(".not-found").show()})}),e=!0},e=!1;if($.ajax({url:"/RailwayService/railwayStation/queryLineStationByStationName.do?stationName="+obj.startStation,type:"GET",dataType:"json",async:!1,success:function(t){t.success&&a(t.data)},complete:function(t){e||toast(200===t.status?t.responseJSON.message:t.statusText)}}),t){var n=$('.box-block[data-trip="'+t+'"]');0!==n.length?n.click():($("#train").find("i.iconfont").hide(),$("#train").find("span").text(t).show(),$("a.active").next().click(),renderDestination(obj.destination))}};$("div.change-type").click(function(){$("ul").show()}),$("ul li").click(function(){var t=$(this).parents(".change-type").find("span"),a=$(this).text();a!==t.text()&&($(this).parents(".weui-flex").find("input").val("").keyup(),"高铁G"===a?($(".gaotie").show(),$(".dongche").hide()):($(".dongche").show(),$(".gaotie").hide())),t.text(a)});var renderDestination=function(t){var a=function(t){$("#terminal .city-content").empty().append('<div class="not-found" style="display: none;">未查询到发车的车次</div>'),$.each(t,function(){$("#terminal .city-content").append('<div class="box-block block" data-target="#end" data-name="'+this.station+'" data-id="'+this.cityId+'" data-time="'+this.arriveTime+'" data-abbr="'+this.stationNameAbbr+'" data-spell="'+this.spel+'"><span>'+this.station+"</span></div>")}),$("#terminal .city-content").find(".box-block:not(:nth-last-of-type(n+"+get_last_num(t.length)+"))").removeClass("block"),e=!0},e=!1;$.ajax({url:"/RailwayService/railwayStation/getDestinationByStationAndNo.do?",type:"GET",data:{stationName:obj.startStation,lineNo:obj.trip},dataType:"json",async:!1,success:function(t){t.success&&a(t.data)},complete:function(t){e||toast(200===t.status?t.responseJSON.message:t.statusText)}}),t&&$('.box-block[data-target="#end"][data-name="'+t+'"]').click()};$('[data-name^="content"]').on("click",".box-block",function(){$(this).addClass("click")}).on("transitionend",".box-block",function(){var t=$(this).find("span:first-child").text().trim(),a=$(this).data("target"),e=$(a),n=$(this).data("toggle"),i=e.find("span"),o=e.find("i"),s=i.text(),r=e.parents("a"),c=r.nextAll().find(".nav-value"),d=c.find("span"),l=c.find("i.iconfont");if($(this).removeClass("click"),n){var h=$(this).parents(".trip-content"),u=h.next();return h.hide(),u.show().children("div").hide(),u.find(n).show(),!1}i.text(t).show(),t!==s&&(o.hide(),d.hide(),l.show()),$(c[0]).click(),"#start"===a?(obj.startStation=t,obj.startStationId=$(this).data("stationid"),delete obj.trip,delete obj.destination,renderTrain(obj.modify?obj.trip:void 0)):"#train"===a?(delete obj.destination,obj.trip=t,obj.aboardTime=$(this).find(".time").text().trim(),renderDestination(obj.modify?obj.destination:void 0)):(obj.destination=t,obj.cityId=$(this).data("id"),obj.arriveTime=$(this).data("time"))}),$("input.weui-input").on("input paste propertychange",function(){query(this)}),$("footer a").click(function(){if("route"===$(this).data("name")){if(!(obj.startStation&&obj.trip&&obj.destination))return $.toast("行程设置不正确","forbidden"),!1;obj.init=!0,sessionStorage.Order?obj.startStationId!==sessionStorage.stationId.trim()?$.confirm("该商家所在站点不在该行程中, 是否继续?","警告",function(){save_route(obj,"payOrder.html")}):save_route(obj,"payOrder.html"):save_route(obj,"index.html")}else sessionStorage.Order?$.confirm("行程尚未设置完成是否跳过?","提示",function(){window.location.href="payOrder.html"}):window.location.href="index.html"}),$("input").focus(function(){obj.text=$(this).attr("placeholder"),$(this).attr("placeholder","")}).blur(function(){$(this).attr("placeholder",obj.text)}),sessionStorage.route?(obj=JSON.parse(sessionStorage.route),obj.modify=!0,renderAllStations(),renderTrain(),renderDestination(),$("i.icon-xiala").hide(),$("#start span").text(obj.startStation).show(),$("#train span").text(obj.trip).show(),$("#end span").text(obj.destination).click().show(),delete obj.modify):getCurrentStation();